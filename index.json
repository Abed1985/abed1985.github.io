[{"content":"\u003ch2 id=\"block-sensitive-data-leak-to-chatgpt-example\"\u003eBlock sensitive data leak to ChatGPT example\u003c/h2\u003e\n\u003cp\u003eDLP (Data Leak Prevention) has become increasingly crucial with the rise of LLM AI platforms. Many users rely on AI chat platforms to simplify both their work and personal tasks.\u003c/p\u003e\n\u003cp\u003eWhile this convenience is beneficial, it also raises the risk of unintentionally exposing sensitive organizational information. LLM models can incorporate leaked data into their training sets, potentially making it part of responses to external users—significantly increasing security risks.\u003c/p\u003e\n\u003cp\u003eA notable example is the Samsung data leak to ChatGPT: \u003ca href=\"https://www.forbes.com/sites/siladityaray/2023/05/02/samsung-bans-chatgpt-and-other-chatbots-for-employees-after-sensitive-code-leak/\"\u003ehttps://www.forbes.com/sites/siladityaray/2023/05/02/samsung-bans-chatgpt-and-other-chatbots-for-employees-after-sensitive-code-leak/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eA comprehensive DLP solution can effectively address these challenges. But what if a customer has a FortiGate firewall and wants to leverage its DLP capabilities to mitigate these risks?\u003c/p\u003e\n\u003ch2 id=\"prerequisites\"\u003ePrerequisites\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eKeyword and Data Samples: Ensure a predefined list of keywords and data samples is available for DLP matching.\u003c/li\u003e\n\u003cli\u003eProxy-Based Firewall Policy with Deep SSL Inspection:\n\u003cul\u003e\n\u003cli\u003eEndpoints must trust the Fortinet CA SSL certificate used for deep inspection.\u003c/li\u003e\n\u003cli\u003eCertificate distribution can be managed via an MDM or onboarded using FortiClient EMS as part of the Fortinet Security Fabric.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eDLP Security Profile: Configure a DLP security profile and attach it to the firewall policy.\u003c/li\u003e\n\u003cli\u003eBlocking QUIC Protocol:\n\u003cul\u003e\n\u003cli\u003eWhen using a DLP profile in a proxy-based firewall policy, it\u0026rsquo;s recommended to block the QUIC protocol in application control profiles.\u003c/li\u003e\n\u003cli\u003eBy default, FortiOS 7.0–7.2 can only inspect QUIC traffic in HTTP/3 in flow mode.\u003c/li\u003e\n\u003cli\u003eExplicitly blocking QUIC in application control forces most traffic on UDP/443 to revert to TCP/443, allowing FortiGate to properly inspect it.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"procedures\"\u003eProcedures\u003c/h2\u003e\n\u003ch3 id=\"step-1-determine-what-do-you-want-to-prevent-from-leaking\"\u003eStep 1: Determine what do you want to prevent from leaking\u003c/h3\u003e\n\u003cp\u003eIn this example I will prevent leaking to chatGPT the following:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAny text/keyword that contains \u0026ldquo;abood\u0026rdquo;.\u003c/li\u003e\n\u003cli\u003eAny IP address that matches the subnet 1.1.1.0/24 as an example.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis will be matched using regex. Tools such as \u003ca href=\"https://regex101.com\"\u003ehttps://regex101.com\u003c/a\u003e can help fine tunning the pattern you are after.\u003c/p\u003e\n\u003ch3 id=\"step-2-enable-dlp\"\u003eStep 2: Enable DLP\u003c/h3\u003e\n\u003cp\u003eEnable Data Leak prevention under feature visibility.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_featurev.png\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003ch3 id=\"step-3-create-dlp-dictionary\"\u003eStep 3: Create DLP Dictionary\u003c/h3\u003e\n\u003cp\u003eUnder Data Leak Prevention create a new DLP dictionary with 2 dictionary entry to cover the use cases.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eDictionary entry with type \u0026ldquo;Keyword\u0026rdquo; to match \u0026ldquo;abood\u0026rdquo; keyword in text.\u003c/li\u003e\n\u003cli\u003eDictionary entry with type \u0026ldquo;Regex\u0026rdquo; to match 1.1.1.0/24 a regex match to cover the subnet (any ip within the range)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_dict1.png\" alt=\"My Image\"\u003e\n\u003cbr\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_dict2.png\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003ch3 id=\"step-4-create-a-dlp-sensor\"\u003eStep 4: Create a DLP Sensor\u003c/h3\u003e\n\u003cp\u003eUnder Data Leak Prevention create a new DLP sensor and reference the dlp dictionary created earlier.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_sen1.png\" alt=\"My Image\"\u003e\n\u003cbr\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_sen2.png\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003ch3 id=\"step-4-create-a-dlp-profile\"\u003eStep 4: Create a DLP Profile\u003c/h3\u003e\n\u003cp\u003eUnder Data Leak Prevention create a new DLP profile with 2 rules per below referencing the earlier DLP sensor.\n\u003cbr\u003e\nThe first rule is with type file, and the second rule with type message. Applying settings as shown on the GUI\n\u003cbr\u003e\nFor the first rule (file) On the CLI Unset the file type option to enable filtering of all file types, including unknown ones (unset file-type)\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_prof1.png\" alt=\"My Image\"\u003e\n\u003cbr\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_prof2.png\" alt=\"My Image\"\u003e\n\u003cbr\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_prof3.png\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003ch4 id=\"the-complete-cli-commands-for-the-dlp-dictionary-sensor-profile-looks-like-this\"\u003eThe complete CLI commands for the DLP Dictionary, sensor, profile looks like this\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003eFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN \u003cspan style=\"color:#75715e\"\u003e# config dlp dictionary \u003c/span\u003e\n\nFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN (dictionary) \u003cspan style=\"color:#75715e\"\u003e# show\u003c/span\u003e\nconfig dlp dictionary\n    edit \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;llmapps\u0026#34;\u003c/span\u003e\n        set uuid f24f4ee4\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003efd65\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e51\u003c/span\u003eee\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003ef5e\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003ef6f999f30d0\n        set comment \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;block leaks to  AI platforms\u0026#34;\u003c/span\u003e\n        config entries\n            edit \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n                set type \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;keyword\u0026#34;\u003c/span\u003e\n                set pattern \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;brennan\u0026#34;\u003c/span\u003e\n            next\n            edit \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\n                set type \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;regex\u0026#34;\u003c/span\u003e\n                set pattern \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003eb210\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e.18\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e.244\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e.(?:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003ed{1,2}|1\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003ed{2}|2[0-4]\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003ed|25[0-4])\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003eb\u0026#34;\u003c/span\u003e\n            next\n        end\n    next\nend\n\nFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN (dictionary) \u003cspan style=\"color:#75715e\"\u003e# end\u003c/span\u003e\n\nFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN \u003cspan style=\"color:#75715e\"\u003e# config dlp sensor \u003c/span\u003e\n\nFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN (sensor) \u003cspan style=\"color:#75715e\"\u003e# show\u003c/span\u003e\nconfig dlp sensor\n    edit \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;llmapps\u0026#34;\u003c/span\u003e\n        config entries\n            edit \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n                set dictionary \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;llmapps\u0026#34;\u003c/span\u003e\n            next\n        end\n    next\nend\n\nFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN (sensor) \u003cspan style=\"color:#75715e\"\u003e# end\u003c/span\u003e\n\nFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN \u003cspan style=\"color:#75715e\"\u003e# config dlp profile \u003c/span\u003e\n\nFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN (profile) \u003cspan style=\"color:#75715e\"\u003e# show\u003c/span\u003e\nconfig dlp profile\n    edit \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;default\u0026#34;\u003c/span\u003e\n        set comment \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Default profile.\u0026#34;\u003c/span\u003e\n    next\n    edit \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sniffer-profile\u0026#34;\u003c/span\u003e\n        set comment \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Log a summary of email and web traffic.\u0026#34;\u003c/span\u003e\n        set summary\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eproto smtp pop3 imap http\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eget http\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003epost\n    next\n    edit \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;def-cc-sensor\u0026#34;\u003c/span\u003e\n    next\n    edit \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;SSN-Sensor-r1s\u0026#34;\u003c/span\u003e\n    next\n    edit \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;def-ssn-sensor\u0026#34;\u003c/span\u003e\n    next\n    edit \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;llmapps\u0026#34;\u003c/span\u003e\n        config rule\n            edit \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n                set name \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;llmapps1\u0026#34;\u003c/span\u003e\n                set severity critical\n                set proto http\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003epost\n                set filter\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eby sensor\n                set sensor \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;llmapps\u0026#34;\u003c/span\u003e\n                set action block\n            next\n            edit \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\n                set name \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;llmapps2\u0026#34;\u003c/span\u003e\n                set severity critical\n                set type message\n                set proto http\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003epost\n                set filter\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eby sensor\n                set sensor \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;llmapps\u0026#34;\u003c/span\u003e\n                set action block\n            next\n        end\n    next\nend\n\nFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN (profile) \u003cspan style=\"color:#75715e\"\u003e# \u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"step-4-create-an-address-object\"\u003eStep 4: Create an address object\u003c/h3\u003e\n\u003cp\u003eCreate an address object type \u0026ldquo;FQDN\u0026rdquo; for \u0026ldquo;chat.openai.com\u0026rdquo;\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_addr.png\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003ch3 id=\"step-5-create-an-app-control-profile\"\u003eStep 5: Create an APP control profile\u003c/h3\u003e\n\u003cp\u003eCreate an application control profile with default settings (monitor all), with an override to block the QUIC protocol.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_appprof.png\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003ch3 id=\"step-6-create-a-firewall-policy\"\u003eStep 6: Create a Firewall Policy\u003c/h3\u003e\n\u003cp\u003eCreate A firewall policy referencing the following:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eFQDN address created earlier as a destination.\u003c/li\u003e\n\u003cli\u003eThe Application control profile created earlier.\u003c/li\u003e\n\u003cli\u003eThe DLP profile created earlier.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe policy inspection type need to be proxy based , and using deep inspection.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_fwp.PNG\" alt=\"My Image\"\u003e\n\u003cbr\u003e\n\u003cbr\u003e\u003c/p\u003e\n\u003ch3 id=\"step-7-testing\"\u003eStep 7: Testing\u003c/h3\u003e\n\u003cp\u003eLets now visit the website and attempt leaking information. Note that the \u0026ldquo;Fortinet\u0026rdquo; CA SSL certificate present itself for deep inspection.\u003c/p\u003e\n\u003cp\u003eThats why its a prerequiste that the CA cert is imported to avoid certificate warning when a traffic interception occurs at the fortigate level as part of SSL decryption process.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_deepinspection.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003cp\u003eAs per the testing below, notice that anything that contains \u0026ldquo;abood\u0026rdquo; or any ip from subnet 1.1.1.0/24 is not being leaked to ChatGPT.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_test1.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_test2.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_test3.PNG\" alt=\"My Image\"\u003e\n\u003cbr\u003e\n\u003cbr\u003e\u003c/p\u003e\n\u003ch4 id=\"notice-the-dlp-logs-about-the-these-patterns-being-blocked\"\u003eNotice the dlp logs about the these patterns being blocked\u003c/h4\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/dlp_testoutcome.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n","description":"","image":"/images/fortinet/dlp_1.png","permalink":"https://abed1985.github.io/blogs/fortinet-dlp/","title":"Fortigate user level DLP"},{"content":"\u003ch2 id=\"what-is-saml\"\u003eWhat is SAML\u003c/h2\u003e\n\u003cp\u003eSAML (Security Assertion Markup Language) is an XML based (but Base64 encoded) protocol.It is a standard protocol for web Single Sign-On (SSO)  \u0026amp; Federated identity.\nSAML allows apps and services to offload \u0026ldquo;authentication\u0026rdquo; to a trusted 3rd party. SSO intended to be easy for the user and transparent after the user has logged in the first time.\u003c/p\u003e\n\u003ch3 id=\"key-terms\"\u003eKey terms\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eFederated Identity:  Linking a user\u0026rsquo;s identity across different identity management systems/domains. eg. between two different organizations like a service porvider \u0026amp; a customer.\u003c/li\u003e\n\u003cli\u003eIdP - Identity Provider: Authenticates the user. It is the user directory. Like Azure AD or G suite, FortiAuthenticator, Cisco ISE, or any other user directory.\n\u003cul\u003e\n\u003cli\u003eEntity ID :\n\u003cul\u003e\n\u003cli\u003eBoth Idp and SP have an EntityID which is a globally unique name for a SAML entity.\u003c/li\u003e\n\u003cli\u003eMust be a URI, typically is a URL\u003c/li\u003e\n\u003cli\u003eDoes not need to be resolvable as it is an identifier, not a web location\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eSingle SignOn Service endpoint:\n\u003cul\u003e\n\u003cli\u003eMust be HTTPS URL\u003c/li\u003e\n\u003cli\u003eThis is the URL the user is redirected to by the SP with the SAML auth request ( Base64 encoded XML).\u003c/li\u003e\n\u003cli\u003eThe IdP will respond by challenging the user to login ( i.e present a login page to the user, and do MFA if configured).\u003c/li\u003e\n\u003cli\u003eAlso referred to as the IdP login URL.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eSingle Logout Service ( SLS) endpoint:\n\u003cul\u003e\n\u003cli\u003eThe user is redirected to the IdP SLS URL to log them out of the IdP when they have chosen to logout of the SP.\u003c/li\u003e\n\u003cli\u003eThe IdP may ( if configured to do so) then send a logout request directly to other SP\u0026rsquo;s that are also participants in this user\u0026rsquo;s SSO session.\u003c/li\u003e\n\u003cli\u003eAlso referred to as the IdP logout URL\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eService Provider (SP): Provides services to the user. An access proxy or anything like Salesforce, AWS, Egnyte..\u003c/li\u003e\n\u003cli\u003eAssertion: A statement about a user\u0026rsquo;s identity made by the Idp.\n\u003cul\u003e\n\u003cli\u003eMay contain attributes such as username,groups, email address.\n\u003col\u003e\n\u003cli\u003eI have authenticated this user as abood\u003c/li\u003e\n\u003cli\u003eabood email address is \u003ca href=\"mailto:abood@gmail.com\"\u003eabood@gmail.com\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eabood belongs to these groups: immortals, actionheroes, super_admin\u003c/li\u003e\n\u003cli\u003eabood first name is Abood\u003c/li\u003e\n\u003cli\u003eabood surname is Alakhras.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cbr\u003e\n\u003ch3 id=\"saml-generic-sp-initiated-auth-flow\"\u003eSAML Generic SP Initiated Auth Flow\u003c/h3\u003e\n\u003cbr\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/saml_2.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003cp\u003eService provider (SP) that uses SAML authentication should not support IdP initiated SAML auth, due to it being less secure.\nIdP initiated has been described as like a CSRF/XSRF (Cross Site Request Forgery) attack.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/saml_3.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003eSome content and images in this post are sourced from \u003ca href=\"https://www.fortinet.com\"\u003eFortinet\u003c/a\u003e.\u003cbr\u003e\nAll rights belong to their respective owners.\u003c/em\u003e\u003c/p\u003e\n","description":"","image":"/images/fortinet/saml_1.png","permalink":"https://abed1985.github.io/blogs/saml-authentication/","title":"Saml Authentication"},{"content":"\u003cp\u003eFortiGate support guest Wi-Fi with a captive portal with the portal being the FortiGate itself. The following two login methods can be used:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCaptive portal login with username/password provided to guest users:Accounts are created in bulk on the FortiGate and printed to be provided to end users (e.g., by reception).\u003c/li\u003e\n\u003cli\u003eCaptive portal login with guests’ email address only:This is a less preferred option. Email collection can be done from FortiGate and exported for marketing use if a certain legal agreement allow it.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis guide assumes that FortiAP is connected to FortiGate via the security fabric. All Wi-Fi configuration and SSID creation is done from the FortiGate.\u003c/p\u003e\n\u003ch2 id=\"captive-portal-with-usernamepassword-provided-to-guest-users\"\u003eCaptive Portal with Username/Password Provided to Guest Users\u003c/h2\u003e\n\u003ch3 id=\"step-1-create-a-guest-group\"\u003eStep 1: Create a Guest Group\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eCreate a group with the type Guest and enable Batch Guest Account Creation.\u003c/li\u003e\n\u003cli\u003eSpecify account expiry (e.g., after 4 hours of logging in or as required).\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/create_guest_group.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003ch3 id=\"step-2-create-a-new-ssid\"\u003eStep 2: Create a New SSID\u003c/h3\u003e\n\u003cp\u003eConfigure the SSID in Tunnel Mode with the following settings:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eSecurity Mode: Captive Portal\u003c/li\u003e\n\u003cli\u003ePortal Type: Authentication\u003c/li\u003e\n\u003cli\u003eAuthentication Portal: Local\u003c/li\u003e\n\u003cli\u003eUser Groups: Guest-Portal (the earlier created group)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/create_new_ssid_1.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/create_new_ssid_2.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003ch3 id=\"step-3-create-user-accounts-in-bulk\"\u003eStep 3: Create User Accounts in Bulk\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eNavigate to User \u0026amp; Authentication → Guest Management → Create New → Multiple Users. The accounts will be generated in bulk.\u003c/li\u003e\n\u003cli\u003ePrint the created accounts to provide on-demand to end users.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/print_user_accounts_1.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/print_user_accounts_2.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003ch3 id=\"step-4-create-a-firewall-policy\"\u003eStep 4: Create a Firewall Policy\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eAllow guest access to the internet. The below policy is for illustration purposes only. Best practice in creating a firewall policy need to be followed, in terms of inspection and required sources and destinations.\u003c/li\u003e\n\u003cli\u003eConfigure additional settings to resolve the guest portal address and trust the web certificate (to be discussed in a later section).\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/create_firewall_policy.PNG\" alt=\"My Image\"\u003e\n\u003cbr\u003e\n\u003cbr\u003e\u003c/p\u003e\n\u003ch2 id=\"captive-portal-with-email-address-only-less-preferred-option\"\u003eCaptive Portal with Email Address Only (Less Preferred Option)\u003c/h2\u003e\n\u003cp\u003eThis option is less preferred, as publicly granting access to networks with just an email address is not ideal, even with strict guest network settings. However, it can be viable for retail use.\u003c/p\u003e\n\u003ch3 id=\"step-1-enable-email-collection\"\u003eStep 1: Enable Email Collection\u003c/h3\u003e\n\u003cp\u003eUnder Feature Visibility allow email collection.\u003c/p\u003e\n\u003ch3 id=\"step-2-update-ssid-settings\"\u003eStep 2: Update SSID Settings\u003c/h3\u003e\n\u003cp\u003eChange the Portal Type under the SSID settings to Email Collection.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/update_ssid_settings.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003ch3 id=\"step-3-add-device-management-widget-optional\"\u003eStep 3: Add Device Management Widget (Optional)\u003c/h3\u003e\n\u003cp\u003eAdd a widget to manage devices with listed email addresses. Under Dashboard \u0026gt; Users \u0026amp; Device \u0026gt; Add Widget\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/add_devicemanagement_widget.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003ch3 id=\"step-4-update-the-firewall-policy\"\u003eStep 4: Update the Firewall Policy\u003c/h3\u003e\n\u003cp\u003eIn CLI, allow \u0026ldquo;email-collect\u0026rdquo; under the firewall policy for guest traffic to the internet:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003eFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN \u003cspan style=\"color:#75715e\"\u003e# config firewall policy \u003c/span\u003e\nFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN (policy) \u003cspan style=\"color:#75715e\"\u003e# edit 7\u003c/span\u003e\nFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN (\u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e) \u003cspan style=\"color:#75715e\"\u003e# show\u003c/span\u003e\nconfig firewall policy\n    edit \u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e\n        set name \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;GuestWiFi\u0026#34;\u003c/span\u003e\n        set uuid bb2c74d4\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e29\u003c/span\u003ec9\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e51\u003c/span\u003eee\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eb1e5\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003ec452b399da9f\n        set srcintf \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Alakhras Guests\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Alakhras Guest2\u0026#34;\u003c/span\u003e\n        set dstintf \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;WAN\u0026#34;\u003c/span\u003e\n        set action accept\n        set srcaddr \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Alakhras Guests address\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Alakhras Guest2 address\u0026#34;\u003c/span\u003e\n        set dstaddr \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;all\u0026#34;\u003c/span\u003e\n        set schedule \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;always\u0026#34;\u003c/span\u003e\n        set service \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ALL\u0026#34;\u003c/span\u003e\n        set logtraffic all\n        set nat enable\n        set email\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003ecollect enable\n    next\nend\nFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN (\u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e) \u003cspan style=\"color:#75715e\"\u003e# \u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"other-required-settings\"\u003eOther Required Settings\u003c/h2\u003e\n\u003ch3 id=\"customize-the-login-portal-page\"\u003eCustomize the Login Portal Page\u003c/h3\u003e\n\u003cp\u003eThe portal can be customized under System → Replacement Messages:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eOption I : Login Page/Failed Login Page: Customize the HTML pages for username/password login.\u003c/li\u003e\n\u003cli\u003eOption II : Email Collection/ Email Collection Invalid Email HTML pages for email collection login.\u003c/li\u003e\n\u003cli\u003eManage Images: Add images for the login portal.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eLets say id like to add a logo I have in .png format to appear on login page. System \u0026gt; Replacement Messages \u0026gt; Manage Images \u0026gt; Create New\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/customize_login_portal_page.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003cp\u003eTake note of the logo name you are using \u0026ldquo;mylogo\u0026rdquo;, as this will be referenced in the HTML page later to load your new logo.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/customize_logo.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003cp\u003eThe logo along with the portal \u0026ldquo;Login Page\u0026rdquo; can be tailored by modifying the HTML page easily:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/customize_logo_login.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n\u003cp\u003eThe rest of the HTML pages can be tailored in the same approach.\nThe changes are dynamic and visible while you edit. You don\u0026rsquo;t have to be a web developer to do minor changes to tailor your login page :)\u003c/p\u003e\n\u003ch3 id=\"resolve-the-guest-portal-address\"\u003eResolve the Guest Portal Address\u003c/h3\u003e\n\u003cp\u003eIts important to know that the guest portal resolves to the Guest SSID Gateway Interface IP. Two configurations are required:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eDNS Entry:\n\u003cul\u003e\n\u003cli\u003eEnable DNS Database in Feature Visibility.\u003c/li\u003e\n\u003cli\u003eAllow DNS service on the Guest Interface.\u003c/li\u003e\n\u003cli\u003eCreate a DNS Zone with the customer domain name (e.g., customerx.com) and an A record for the guest portal (e.g., guest.customerx.com).\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThe above can be executed from either the GUI under Network \u0026gt; DNS Servers or from the CLI like below:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003eFG\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eABOOD\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eDC\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eWAN (netsecops) \u003cspan style=\"color:#75715e\"\u003e# show\u003c/span\u003e\nconfig system dns\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003edatabase\n    edit \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;netsecops\u0026#34;\u003c/span\u003e\n        set domain \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;net-sec-ops.com\u0026#34;\u003c/span\u003e\n        set authoritative disable\n        config dns\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eentry\n            edit \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n                set hostname \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;guest\u0026#34;\u003c/span\u003e\n                set ip \u003cspan style=\"color:#ae81ff\"\u003e192.168\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e50.1\u003c/span\u003e\n            next\n        end\n    next\nend\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"2\"\u003e\n\u003cli\u003eTrusted Certificate:\n\u003cul\u003e\n\u003cli\u003eImport a trusted certificate (e.g., a wildcard certificate for customerx.com) into the FortiGate that has the FQDN address as SN.\u003c/li\u003e\n\u003cli\u003eConfigure the Guest SSID interface in CLI to use the FQDN (that resolves to the Guest SSID L3 Gateway) and certificate:\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003econfig wireless\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003econtroller vap\n    edit \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Alakhras Guest2\u0026#34;\u003c/span\u003e\n        set ssid \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Alakhras Guest2\u0026#34;\u003c/span\u003e\n        set security captive\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eportal\n        set portal\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003etype email\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003ecollect\n        set security\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eredirect\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eurl \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;http://www.net-sec-ops.com/redirect-url/\u0026#34;\u003c/span\u003e\n        set auth\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003ecert \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;abood-dc-wan.net-sec-ops.com\u0026#34;\u003c/span\u003e\n        set auth\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eportal\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eaddr \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;guest.net-sec-ops.com\u0026#34;\u003c/span\u003e\n        set schedule \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;always\u0026#34;\u003c/span\u003e\n    next\nend\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"managing-guest-users\"\u003eManaging Guest Users\u003c/h3\u003e\n\u003cp\u003eIf the customer wishes to manage guest user accounts, create a guest admin account tied to a trusted host subnet.\nThis allows the admin to log in and access only the Guest Management section of the FortiGate interface.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/fortinet/guest_admin_page.PNG\" alt=\"My Image\"\u003e\u003c/p\u003e\n","description":"","image":"/images/fortinet/FortiAP.png","permalink":"https://abed1985.github.io/blogs/fortinet-guest-wifi/","title":"Fortinet Guest Wifi with Captive Portal"}]